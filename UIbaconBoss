local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")

local UILibrary = {}

function UILibrary:CreateWindow(title, size)
    local ScreenGui = Instance.new("ScreenGui", game.CoreGui)
    ScreenGui.Name = "BaconBossUI"
    ScreenGui.ResetOnSpawn = false
    ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    
    -- üåô Overlay t·ªëi m·ªù FULL M√ÄN H√åNH
    local Overlay = Instance.new("Frame", ScreenGui)
    Overlay.Size = UDim2.new(1, 0, 1, 0)
    Overlay.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    Overlay.BackgroundTransparency = 1
    Overlay.ZIndex = 1
    Overlay.Name = "Overlay"
    
    local MainFrame = Instance.new("Frame")
    MainFrame.Size = size or UDim2.new(0, 520, 0, 340)
    MainFrame.Position = UDim2.new(0.5, -260, 0.5, -170) -- Canh gi·ªØa m√†n h√¨nh
    MainFrame.BackgroundColor3 = Color3.fromRGB(25, 35, 25)
    MainFrame.Active = true
    MainFrame.Draggable = true -- ƒê√É B·∫¨T DRAGGABLE
    MainFrame.Selectable = true
    MainFrame.Parent = ScreenGui
    MainFrame.ClipsDescendants = true
    MainFrame.ZIndex = 10
    MainFrame.Name = "MainWindow"
    
    -- T·∫°o InputBeginDrag v√† InputEndDrag ƒë·ªÉ k√©o
    MainFrame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            MainFrame.Dragging = true
            local dragStart = input.Position
            local frameStart = MainFrame.Position
            
            local connection
            connection = input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    MainFrame.Dragging = false
                    connection:Disconnect()
                end
            end)
            
            local dragConnection
            dragConnection = UserInputService.InputChanged:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseMovement and MainFrame.Dragging then
                    local delta = input.Position - dragStart
                    MainFrame.Position = UDim2.new(
                        frameStart.X.Scale, 
                        frameStart.X.Offset + delta.X,
                        frameStart.Y.Scale,
                        frameStart.Y.Offset + delta.Y
                    )
                end
            end)
        end
    end)
    
    local MainCorner = Instance.new("UICorner", MainFrame)
    MainCorner.CornerRadius = UDim.new(0, 12)
    
    local Shadow = Instance.new("ImageLabel", MainFrame)
    Shadow.AnchorPoint = Vector2.new(0.5, 0.5)
    Shadow.Position = UDim2.new(0.5, 0, 0.5, 0)
    Shadow.Size = UDim2.new(1, 40, 1, 40)
    Shadow.BackgroundTransparency = 1
    Shadow.Image = "rbxassetid://6014261993"
    Shadow.ImageTransparency = 0.48
    Shadow.ZIndex = 9
    
    local Stroke = Instance.new("UIStroke", MainFrame)
    Stroke.Color = Color3.fromRGB(40, 60, 40)
    Stroke.Thickness = 1.5
    Stroke.Transparency = 0.3
    Stroke.LineJoinMode = Enum.LineJoinMode.Round
    
    local TopBar = Instance.new("Frame", MainFrame)
    TopBar.Size = UDim2.new(1, 0, 0, 38)
    TopBar.BackgroundColor3 = Color3.fromRGB(35, 50, 35)
    TopBar.ZIndex = 12
    TopBar.Name = "TopBar"
    
    -- CH·ªà CORNER 2 G√ìC TR√äN
    local TopCorner = Instance.new("UICorner", TopBar)
    TopCorner.CornerRadius = UDim.new(0, 12)
    
    local Grad = Instance.new("UIGradient", TopBar)
    Grad.Color = ColorSequence.new({
        ColorSequenceKeypoint.new(0, Color3.fromRGB(45, 65, 45)),
        ColorSequenceKeypoint.new(1, Color3.fromRGB(30, 45, 30)),
    })
    
    -- üìå TH√äM N√öT MINIMIZE (·∫®N LABEL) - N√öT TR√íN B√äN TR√ÅI
    local MinimizeBtn = Instance.new("ImageButton", TopBar)
    MinimizeBtn.Size = UDim2.new(0, 28, 0, 28)
    MinimizeBtn.Position = UDim2.new(0, 8, 0.5, -14)
    MinimizeBtn.BackgroundColor3 = Color3.fromRGB(60, 90, 60)
    MinimizeBtn.Image = "rbxassetid://3926307971"
    MinimizeBtn.ImageRectOffset = Vector2.new(964, 324) -- Icon m≈©i t√™n xu·ªëng
    MinimizeBtn.ImageRectSize = Vector2.new(36, 36)
    MinimizeBtn.ImageColor3 = Color3.fromRGB(220, 255, 220)
    MinimizeBtn.AutoButtonColor = false
    MinimizeBtn.ZIndex = 13
    MinimizeBtn.Visible = true -- Lu√¥n hi·ªán
    
    local MinimizeCorner = Instance.new("UICorner", MinimizeBtn)
    MinimizeCorner.CornerRadius = UDim.new(1, 0)
    
    local MinimizeStroke = Instance.new("UIStroke", MinimizeBtn)
    MinimizeStroke.Color = Color3.fromRGB(80, 120, 80)
    MinimizeStroke.Thickness = 1.5
    
    local Title = Instance.new("TextLabel", TopBar)
    Title.Text = title or "‚ú® Bacon Boss"
    Title.TextColor3 = Color3.fromRGB(240, 255, 240)
    Title.BackgroundTransparency = 1
    Title.Font = Enum.Font.GothamBold
    Title.Position = UDim2.new(0, 45, 0, 0) -- D·ªùi sang ph·∫£i cho n√∫t minimize
    Title.Size = UDim2.new(1, -100, 1, 0) -- Gi·∫£m width
    Title.TextSize = 16
    Title.TextXAlignment = Enum.TextXAlignment.Left
    Title.ZIndex = 13
    Title.TextStrokeColor3 = Color3.fromRGB(10, 20, 10)
    Title.TextStrokeTransparency = 0.7
    Title.Name = "WindowTitle"
    
    -- üåü N√∫t thu g·ªçn UI (thay th·∫ø n√∫t X) - B√äN PH·∫¢I
    local HideBtn = Instance.new("ImageButton", TopBar)
    HideBtn.Size = UDim2.new(0, 34, 1, -8)
    HideBtn.Position = UDim2.new(1, -40, 0, 4)
    HideBtn.BackgroundColor3 = Color3.fromRGB(50, 80, 50)
    HideBtn.Image = "rbxassetid://3926305904"
    HideBtn.ImageRectOffset = Vector2.new(884, 284) -- Icon d·∫•u "-"
    HideBtn.ImageRectSize = Vector2.new(36, 36)
    HideBtn.ImageColor3 = Color3.fromRGB(220, 255, 220)
    HideBtn.AutoButtonColor = false
    HideBtn.ZIndex = 13
    
    local HideCorner = Instance.new("UICorner", HideBtn)
    HideCorner.CornerRadius = UDim.new(0, 8)
    
    local HideStroke = Instance.new("UIStroke", HideBtn)
    HideStroke.Color = Color3.fromRGB(70, 110, 70)
    HideStroke.Thickness = 1.5
    HideStroke.Transparency = 0.2
    
    -- Hi·ªáu ·ª©ng hover cho n√∫t ·∫©n
    HideBtn.MouseEnter:Connect(function()
        HideBtn.BackgroundColor3 = Color3.fromRGB(60, 100, 60)
        HideStroke.Color = Color3.fromRGB(80, 130, 80)
    end)
    
    HideBtn.MouseLeave:Connect(function()
        HideBtn.BackgroundColor3 = Color3.fromRGB(50, 80, 50)
        HideStroke.Color = Color3.fromRGB(70, 110, 70)
    end)
    
    -- Container ch√≠nh (ch·ª©a c√°c label, button, toggle)
    local Container = Instance.new("Frame", MainFrame)
    Container.BackgroundTransparency = 1
    Container.Position = UDim2.new(0, 0, 0, 40)
    Container.Size = UDim2.new(1, 0, 1, -45)
    Container.ZIndex = 11
    Container.Name = "ContentContainer"
    Container.Visible = true -- M·∫∑c ƒë·ªãnh hi·ªán
    
    local Layout = Instance.new("UIListLayout", Container)
    Layout.Padding = UDim.new(0, 10)
    Layout.HorizontalAlignment = Enum.HorizontalAlignment.Center
    Layout.SortOrder = Enum.SortOrder.LayoutOrder
    
    local Pad = Instance.new("UIPadding", Container)
    Pad.PaddingTop = UDim.new(0, 10)
    Pad.PaddingLeft = UDim.new(0, 10)
    Pad.PaddingRight = UDim.new(0, 10)
    
    -- Tr·∫°ng th√°i UI ·∫©n/hi·ªán
    local Hidden = false
    local ContainerVisible = true -- Tr·∫°ng th√°i container (minimize)
    
    -- H√†m ·∫©n/hi·ªán OVERLAY v√† UI
    local function ToggleUI()
        Hidden = not Hidden
        
        if Hidden then
            -- üìå ·∫®n UI (di chuy·ªÉn l√™n + m·ªù)
            TweenService:Create(MainFrame, TweenInfo.new(0.3, Enum.EasingStyle.Quad), {
                Position = UDim2.new(0.5, -260, 0.2, -170), -- Di chuy·ªÉn l√™n tr√™n
                BackgroundTransparency = 0.6
            }):Play()
            
            -- ·∫®n overlay ƒëen
            TweenService:Create(Overlay, TweenInfo.new(0.25), {
                BackgroundTransparency = 1
            }):Play()
            
            -- ƒê·ªïi icon th√†nh d·∫•u "+"
            HideBtn.ImageRectOffset = Vector2.new(4, 284)
            
        else
            -- üìå Hi·ªán UI (v·ªÅ v·ªã tr√≠ c≈©)
            TweenService:Create(MainFrame, TweenInfo.new(0.3, Enum.EasingStyle.Quad), {
                Position = UDim2.new(0.5, -260, 0.5, -170),
                BackgroundTransparency = 0
            }):Play()
            
            -- Hi·ªán overlay ƒëen (70% opacity)
            TweenService:Create(Overlay, TweenInfo.new(0.25), {
                BackgroundTransparency = 0.7
            }):Play()
            
            -- ƒê·ªïi icon th√†nh d·∫•u "-"
            HideBtn.ImageRectOffset = Vector2.new(884, 284)
        end
    end
    
    -- H√†m minimize container (·∫©n c√°c label)
    local function ToggleMinimize()
        ContainerVisible = not ContainerVisible
        
        if ContainerVisible then
            -- Hi·ªán container
            TweenService:Create(Container, TweenInfo.new(0.2), {
                Size = UDim2.new(1, 0, 1, -45)
            }):Play()
            Container.Visible = true
            MinimizeBtn.ImageRectOffset = Vector2.new(964, 324) -- M≈©i t√™n xu·ªëng
        else
            -- ·∫®n container
            TweenService:Create(Container, TweenInfo.new(0.2), {
                Size = UDim2.new(1, 0, 0, 0)
            }):Play()
            task.wait(0.2)
            Container.Visible = false
            MinimizeBtn.ImageRectOffset = Vector2.new(924, 324) -- M≈©i t√™n l√™n
        end
    end
    
    -- K·∫øt n·ªëi s·ª± ki·ªán click
    HideBtn.MouseButton1Click:Connect(ToggleUI)
    MinimizeBtn.MouseButton1Click:Connect(ToggleMinimize)
    
    -- Hi·ªáu ·ª©ng cho n√∫t minimize
    MinimizeBtn.MouseEnter:Connect(function()
        MinimizeBtn.BackgroundColor3 = Color3.fromRGB(70, 110, 70)
    end)
    
    MinimizeBtn.MouseLeave:Connect(function()
        MinimizeBtn.BackgroundColor3 = Color3.fromRGB(60, 90, 60)
    end)
    
    -- Hi·ªÉn th·ªã overlay khi m·ªõi m·ªü UI
    task.spawn(function()
        task.wait(0.1)
        TweenService:Create(Overlay, TweenInfo.new(0.3), {
            BackgroundTransparency = 0.7
        }):Play()
    end)
    
    local Window = {}
    
    -- Th√™m ph∆∞∆°ng th·ª©c GetContainer
    function Window:GetContainer()
        return Container
    end
    
    -- üü¢ BUTTON
    function Window:CreateButton(text, callback)
        local Btn = Instance.new("TextButton", Container)
        Btn.Size = UDim2.new(1, -20, 0, 40)
        Btn.BackgroundColor3 = Color3.fromRGB(40, 60, 40)
        Btn.Text = text
        Btn.TextColor3 = Color3.fromRGB(240, 255, 240)
        Btn.Font = Enum.Font.GothamSemibold
        Btn.TextSize = 14
        Btn.AutoButtonColor = false
        Btn.ZIndex = 12
        
        local BtnCorner = Instance.new("UICorner", Btn)
        BtnCorner.CornerRadius = UDim.new(0, 8)
        
        local BtnStroke = Instance.new("UIStroke", Btn)
        BtnStroke.Color = Color3.fromRGB(60, 90, 60)
        BtnStroke.Thickness = 1.5
        BtnStroke.Transparency = 0.2
        
        -- Hi·ªáu ·ª©ng hover
        Btn.MouseEnter:Connect(function()
            Btn.BackgroundColor3 = Color3.fromRGB(50, 80, 50)
            BtnStroke.Color = Color3.fromRGB(70, 110, 70)
        end)
        
        Btn.MouseLeave:Connect(function()
            Btn.BackgroundColor3 = Color3.fromRGB(40, 60, 40)
            BtnStroke.Color = Color3.fromRGB(60, 90, 60)
        end)
        
        Btn.MouseButton1Click:Connect(function()
            if callback then pcall(callback) end
        end)
        
        return Btn
    end
    
    -- üîò TOGGLE
    function Window:CreateToggle(text, callback, default)
        local ToggleBtn = Instance.new("Frame", Container)
        ToggleBtn.Size = UDim2.new(1, -20, 0, 42)
        ToggleBtn.BackgroundColor3 = Color3.fromRGB(35, 50, 35)
        ToggleBtn.ZIndex = 12
        
        local ToggleCorner = Instance.new("UICorner", ToggleBtn)
        ToggleCorner.CornerRadius = UDim.new(0, 10)
        
        local Stroke = Instance.new("UIStroke", ToggleBtn)
        Stroke.Color = Color3.fromRGB(50, 80, 50)
        Stroke.Thickness = 1.6
        Stroke.Transparency = 0.2
        
        -- Label
        local Label = Instance.new("TextLabel", ToggleBtn)
        Label.Size = UDim2.new(0.7, 0, 1, 0)
        Label.Position = UDim2.new(0, 14, 0, 0)
        Label.BackgroundTransparency = 1
        Label.Font = Enum.Font.GothamSemibold
        Label.TextSize = 14
        Label.TextColor3 = Color3.fromRGB(240, 255, 240)
        Label.TextXAlignment = Enum.TextXAlignment.Left
        Label.Text = text
        Label.ZIndex = 13
        
        -- Switch
        local SwitchBg = Instance.new("Frame", ToggleBtn)
        SwitchBg.Size = UDim2.new(0, 54, 0, 28)
        SwitchBg.Position = UDim2.new(1, -66, 0.5, -14)
        SwitchBg.BackgroundColor3 = Color3.fromRGB(55, 75, 55)
        SwitchBg.BorderSizePixel = 0
        SwitchBg.ZIndex = 13
        
        local SwitchCorner = Instance.new("UICorner", SwitchBg)
        SwitchCorner.CornerRadius = UDim.new(1, 0)
        
        -- Knob
        local Knob = Instance.new("Frame", SwitchBg)
        Knob.Size = UDim2.new(0, 26, 0, 26)
        Knob.Position = UDim2.new(0, 2, 0.5, -13)
        Knob.BackgroundColor3 = Color3.fromRGB(120, 120, 120)
        Knob.BorderSizePixel = 0
        Knob.ZIndex = 14
        
        local KnobCorner = Instance.new("UICorner", Knob)
        KnobCorner.CornerRadius = UDim.new(1, 0)
        
        -- Hitbox
        local Hit = Instance.new("TextButton", ToggleBtn)
        Hit.Size = UDim2.new(1, 0, 1, 0)
        Hit.BackgroundTransparency = 1
        Hit.Text = ""
        Hit.ZIndex = 16
        
        local state = default or false
        
        local function ApplyState(on, instant)
            state = on
            if on then
                local pos = UDim2.new(1, -28, 0.5, -13)
                if instant then 
                    Knob.Position = pos 
                else 
                    Knob:TweenPosition(pos, "Out", "Quad", 0.18, true)
                end
                Knob.BackgroundColor3 = Color3.fromRGB(60, 200, 90)
                SwitchBg.BackgroundColor3 = Color3.fromRGB(40, 140, 70)
            else
                local pos = UDim2.new(0, 2, 0.5, -13)
                if instant then 
                    Knob.Position = pos 
                else 
                    Knob:TweenPosition(pos, "Out", "Quad", 0.18, true)
                end
                Knob.BackgroundColor3 = Color3.fromRGB(120, 120, 120)
                SwitchBg.BackgroundColor3 = Color3.fromRGB(55, 75, 55)
            end
        end
        
        ApplyState(state, true)
        
        Hit.MouseButton1Click:Connect(function()
            ApplyState(not state)
            if callback then pcall(function() callback(state) end) end
        end)
        
        return ToggleBtn
    end
    
    -- üìù LABEL
    function Window:CreateLabel(text)
        local Label = Instance.new("TextLabel", Container)
        Label.Size = UDim2.new(1, -20, 0, 28)
        Label.BackgroundTransparency = 1
        Label.Font = Enum.Font.GothamMedium
        Label.TextSize = 14
        Label.TextColor3 = Color3.fromRGB(200, 220, 200)
        Label.TextXAlignment = Enum.TextXAlignment.Left
        Label.Text = text
        Label.ZIndex = 12
        
        return Label
    end
    
    return Window
end

return UILibrary
