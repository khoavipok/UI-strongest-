local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")

local UILibrary = {}

function UILibrary:CreateWindow(title, size)
    local ScreenGui = Instance.new("ScreenGui", game.CoreGui)
    ScreenGui.Name = "BaconBossUI"
    ScreenGui.ResetOnSpawn = false
    ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    
    -- Overlay ƒëen
    local Overlay = Instance.new("Frame", ScreenGui)
    Overlay.Size = UDim2.new(1, 0, 1, 0)
    Overlay.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    Overlay.BackgroundTransparency = 0.7
    Overlay.ZIndex = 1
    Overlay.Name = "Overlay"
    Overlay.Active = false
    Overlay.Selectable = false
    
    -- Main window
    local MainFrame = Instance.new("Frame")
    MainFrame.Size = size or UDim2.new(0, 520, 0, 340)
    MainFrame.Position = UDim2.new(0.5, -260, 0.5, -170)
    MainFrame.BackgroundColor3 = Color3.fromRGB(25, 35, 25)
    MainFrame.Parent = ScreenGui
    MainFrame.ClipsDescendants = true
    MainFrame.ZIndex = 10
    MainFrame.Name = "MainWindow"
    MainFrame.Active = true
    MainFrame.Selectable = true
    
    local MainCorner = Instance.new("UICorner", MainFrame)
    MainCorner.CornerRadius = UDim.new(0, 12)
    
    local Stroke = Instance.new("UIStroke", MainFrame)
    Stroke.Color = Color3.fromRGB(40, 60, 40)
    Stroke.Thickness = 2
    Stroke.Transparency = 0.3
    
    -- Top bar
    local TopBar = Instance.new("Frame", MainFrame)
    TopBar.Size = UDim2.new(1, 0, 0, 40)
    TopBar.BackgroundColor3 = Color3.fromRGB(35, 50, 35)
    TopBar.ZIndex = 12
    TopBar.Name = "TopBar"
    TopBar.Active = true
    TopBar.Selectable = true
    
    local TopCorner = Instance.new("UICorner", TopBar)
    TopCorner.CornerRadius = UDim.new(0, 12)
    
    -- Title
    local Title = Instance.new("TextLabel", TopBar)
    Title.Text = title or "‚ú® Bacon Boss"
    Title.TextColor3 = Color3.fromRGB(240, 255, 240)
    Title.BackgroundTransparency = 1
    Title.Font = Enum.Font.GothamBold
    Title.Position = UDim2.new(0, 15, 0, 0)
    Title.Size = UDim2.new(1, -60, 1, 0)
    Title.TextSize = 16
    Title.TextXAlignment = Enum.TextXAlignment.Left
    Title.ZIndex = 13
    Title.Active = false
    Title.Selectable = false
    
    -- N√∫t toggle ·∫©n/hi·ªán DUY NH·∫§T
    local ToggleBtn = Instance.new("TextButton", TopBar)
    ToggleBtn.Size = UDim2.new(0, 34, 0, 34)
    ToggleBtn.Position = UDim2.new(1, -42, 0.5, -17)
    ToggleBtn.BackgroundColor3 = Color3.fromRGB(50, 80, 50)
    ToggleBtn.Text = "-"
    ToggleBtn.TextColor3 = Color3.fromRGB(240, 255, 240)
    ToggleBtn.Font = Enum.Font.GothamBold
    ToggleBtn.TextSize = 18
    ToggleBtn.ZIndex = 13
    ToggleBtn.AutoButtonColor = false
    ToggleBtn.Name = "ToggleButton"
    
    local ToggleCorner = Instance.new("UICorner", ToggleBtn)
    ToggleCorner.CornerRadius = UDim.new(0, 8)
    
    local ToggleStroke = Instance.new("UIStroke", ToggleBtn)
    ToggleStroke.Color = Color3.fromRGB(70, 110, 70)
    ToggleStroke.Thickness = 2
    
    -- üîÑ SCROLLINGFRAME CH·ª®A N·ªòI DUNG
    local ScrollFrame = Instance.new("ScrollingFrame", MainFrame)
    ScrollFrame.Size = UDim2.new(1, 0, 1, -50)
    ScrollFrame.Position = UDim2.new(0, 0, 0, 45)
    ScrollFrame.BackgroundTransparency = 1
    ScrollFrame.ZIndex = 11
    ScrollFrame.Name = "ScrollContainer"
    ScrollFrame.ScrollingEnabled = true
    ScrollFrame.ScrollBarThickness = 6
    ScrollFrame.ScrollBarImageColor3 = Color3.fromRGB(60, 90, 60)
    ScrollFrame.BorderSizePixel = 0
    ScrollFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
    ScrollFrame.Visible = true
    
    -- Container b√™n trong ScrollFrame
    local Container = Instance.new("Frame", ScrollFrame)
    Container.Size = UDim2.new(1, 0, 0, 0)
    Container.BackgroundTransparency = 1
    Container.ZIndex = 11
    Container.Name = "ContentContainer"
    
    local Layout = Instance.new("UIListLayout", Container)
    Layout.Padding = UDim.new(0, 10)
    Layout.HorizontalAlignment = Enum.HorizontalAlignment.Center
    Layout.SortOrder = Enum.SortOrder.LayoutOrder
    
    local Pad = Instance.new("UIPadding", Container)
    Pad.PaddingTop = UDim.new(0, 10)
    Pad.PaddingLeft = UDim.new(0, 10)
    Pad.PaddingRight = UDim.new(0, 10)
    Pad.PaddingBottom = UDim.new(0, 10)
    
    -- C·∫≠p nh·∫≠t k√≠ch th∆∞·ªõc Canvas
    Layout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
        Container.Size = UDim2.new(1, 0, 0, Layout.AbsoluteContentSize.Y)
        ScrollFrame.CanvasSize = UDim2.new(0, 0, 0, Layout.AbsoluteContentSize.Y + 20)
    end)
    
    -- Bi·∫øn tr·∫°ng th√°i
    local Hidden = false
    
    -- ‚≠ê DRAGGING CROSS-PLATFORM (PC + MOBILE) - T√çCH H·ª¢P
    local dragging = false
    local dragStart
    local startPos
    
    local function update(input)
        local delta = input.Position - dragStart
        MainFrame.Position = UDim2.new(
            startPos.X.Scale, startPos.X.Offset + delta.X,
            startPos.Y.Scale, startPos.Y.Offset + delta.Y
        )
    end
    
    -- B·∫Øt ƒë·∫ßu nh·∫•n v√†o TopBar ho·∫∑c MainFrame ƒë·ªÉ k√©o
    local function dragBegin(input)
        -- Ch·ªâ k√©o khi nh·∫•n v√†o kho·∫£ng tr·ªëng, kh√¥ng ph·∫£i n√∫t
        local target = input.Target
        if target:IsA("TextButton") or target:IsA("TextLabel") then
            return -- Kh√¥ng k√©o n·∫øu nh·∫•n v√†o n√∫t ho·∫∑c label
        end
        
        if input.UserInputType == Enum.UserInputType.MouseButton1 
            or input.UserInputType == Enum.UserInputType.Touch then
            
            dragging = true
            dragStart = input.Position
            startPos = MainFrame.Position

            -- K·∫øt n·ªëi s·ª± ki·ªán th·∫£ chu·ªôt/ng√≥n tay
            local connection
            connection = input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                    if connection then
                        connection:Disconnect()
                    end
                end
            end)
        end
    end
    
    -- K√©o theo di chuy·ªÉn ng√≥n tay/chu·ªôt
    UserInputService.InputChanged:Connect(function(input)
        if dragging then
            if input.UserInputType == Enum.UserInputType.MouseMovement 
               or input.UserInputType == Enum.UserInputType.Touch then
                update(input)
            end
        end
    end)
    
    -- √Åp d·ª•ng cho MainFrame v√† TopBar
    MainFrame.InputBegan:Connect(dragBegin)
    TopBar.InputBegan:Connect(dragBegin)
    
    -- NgƒÉn kh√¥ng cho k√©o t·ª´ n√∫t toggle
    ToggleBtn.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 
            or input.UserInputType == Enum.UserInputType.Touch then
            
            -- Ch·∫∑n s·ª± ki·ªán k√©o t·ª´ n√∫t
            local connection
            connection = input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    if connection then
                        connection:Disconnect()
                    end
                end
            end)
        end
    end)
    
    -- üîß TOGGLE ·∫®N/HI·ªÜN UI
    local function ToggleUI()
        Hidden = not Hidden
        
        if Hidden then
            -- ·∫®n HO√ÄN TO√ÄN: content + overlay
            ScrollFrame.Visible = false
            Overlay.Visible = false  -- ·∫®n overlay ƒëen
            
            -- Thu nh·ªè ch·ªâ c√≤n TopBar
            MainFrame:TweenSize(UDim2.new(MainFrame.Size.X.Scale, MainFrame.Size.X.Offset, 0, 40), 
                               "Out", "Quad", 0.3, true)
            
            -- ƒê·∫©y l√™n tr√™n c√πng
            local currentPos = MainFrame.Position
            local targetY = math.max(5, currentPos.Y.Offset)  -- ƒê·∫£m b·∫£o kh√¥ng ra kh·ªèi m√†n h√¨nh
            MainFrame:TweenPosition(UDim2.new(currentPos.X.Scale, currentPos.X.Offset, 0, targetY), 
                                   "Out", "Quad", 0.3, true)
            
            ToggleBtn.Text = "+"
        else
            -- Hi·ªán l·∫°i T·∫§T C·∫¢
            Overlay.Visible = true  -- Hi·ªán overlay ƒëen
            ScrollFrame.Visible = true
            
            -- Tr·ªü v·ªÅ k√≠ch th∆∞·ªõc ban ƒë·∫ßu
            MainFrame:TweenSize(size or UDim2.new(0, 520, 0, 340), 
                               "Out", "Quad", 0.3, true)
            
            -- K√©o v·ªÅ gi·ªØa m√†n h√¨nh
            MainFrame:TweenPosition(UDim2.new(0.5, -260, 0.5, -170), 
                                   "Out", "Quad", 0.3, true)
            
            ToggleBtn.Text = "-"
        end
    end
    
    -- K·∫øt n·ªëi s·ª± ki·ªán
    ToggleBtn.MouseButton1Click:Connect(ToggleUI)
    
    -- Hi·ªáu ·ª©ng hover cho n√∫t
    ToggleBtn.MouseEnter:Connect(function()
        ToggleBtn.BackgroundColor3 = Color3.fromRGB(60, 100, 60)
    end)
    
    ToggleBtn.MouseLeave:Connect(function()
        ToggleBtn.BackgroundColor3 = Color3.fromRGB(50, 80, 50)
    end)
    
    ToggleBtn.MouseButton1Down:Connect(function()
        ToggleBtn.BackgroundColor3 = Color3.fromRGB(40, 70, 40)
    end)
    
    ToggleBtn.MouseButton1Up:Connect(function()
        ToggleBtn.BackgroundColor3 = Color3.fromRGB(60, 100, 60)
    end)
    
    local Window = {}
    
    function Window:GetContainer()
        return Container
    end
    
    -- üü¢ BUTTON - TH√äM NGƒÇN K√âO
    function Window:CreateButton(text, callback)
        local Btn = Instance.new("TextButton", Container)
        Btn.Size = UDim2.new(1, -20, 0, 40)
        Btn.BackgroundColor3 = Color3.fromRGB(40, 60, 40)
        Btn.Text = text
        Btn.TextColor3 = Color3.fromRGB(240, 255, 240)
        Btn.Font = Enum.Font.GothamSemibold
        Btn.TextSize = 14
        Btn.AutoButtonColor = false
        Btn.ZIndex = 12
        Btn.Active = true
        Btn.Selectable = true
        Btn.Name = "Button_" .. text
        
        local BtnCorner = Instance.new("UICorner", Btn)
        BtnCorner.CornerRadius = UDim.new(0, 8)
        
        local BtnStroke = Instance.new("UIStroke", Btn)
        BtnStroke.Color = Color3.fromRGB(60, 90, 60)
        BtnStroke.Thickness = 1.5
        
        -- NgƒÉn kh√¥ng cho k√©o t·ª´ n√∫t
        Btn.InputBegan:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 
                or input.UserInputType == Enum.UserInputType.Touch then
                
                local connection
                connection = input.Changed:Connect(function()
                    if input.UserInputState == Enum.UserInputState.End then
                        if connection then
                            connection:Disconnect()
                        end
                    end
                end)
            end
        end)
        
        Btn.MouseEnter:Connect(function()
            Btn.BackgroundColor3 = Color3.fromRGB(50, 80, 50)
            BtnStroke.Color = Color3.fromRGB(70, 110, 70)
        end)
        
        Btn.MouseLeave:Connect(function()
            Btn.BackgroundColor3 = Color3.fromRGB(40, 60, 40)
            BtnStroke.Color = Color3.fromRGB(60, 90, 60)
        end)
        
        Btn.MouseButton1Click:Connect(function()
            if callback then 
                pcall(callback) 
            end
        end)
        
        return Btn
    end
    
    -- üîò TOGGLE - TH√äM NGƒÇN K√âO
    function Window:CreateToggle(text, callback, default)
        local ToggleFrame = Instance.new("Frame", Container)
        ToggleFrame.Size = UDim2.new(1, -20, 0, 40)
        ToggleFrame.BackgroundColor3 = Color3.fromRGB(35, 50, 35)
        ToggleFrame.ZIndex = 12
        ToggleFrame.Active = false
        ToggleFrame.Selectable = false
        ToggleFrame.Name = "Toggle_" .. text
        
        local ToggleCorner = Instance.new("UICorner", ToggleFrame)
        ToggleCorner.CornerRadius = UDim.new(0, 8)
        
        local FrameStroke = Instance.new("UIStroke", ToggleFrame)
        FrameStroke.Color = Color3.fromRGB(50, 80, 50)
        FrameStroke.Thickness = 1.5
        
        -- Label
        local Label = Instance.new("TextLabel", ToggleFrame)
        Label.Size = UDim2.new(0.7, 0, 1, 0)
        Label.Position = UDim2.new(0, 10, 0, 0)
        Label.BackgroundTransparency = 1
        Label.Font = Enum.Font.GothamSemibold
        Label.TextSize = 14
        Label.TextColor3 = Color3.fromRGB(240, 255, 240)
        Label.TextXAlignment = Enum.TextXAlignment.Left
        Label.Text = text
        Label.ZIndex = 13
        Label.Active = false
        Label.Selectable = false
        
        -- Switch background
        local SwitchBg = Instance.new("Frame", ToggleFrame)
        SwitchBg.Size = UDim2.new(0, 50, 0, 24)
        SwitchBg.Position = UDim2.new(1, -60, 0.5, -12)
        SwitchBg.BackgroundColor3 = Color3.fromRGB(55, 75, 55)
        SwitchBg.BorderSizePixel = 0
        SwitchBg.ZIndex = 13
        SwitchBg.Active = false
        SwitchBg.Selectable = false
        
        local SwitchCorner = Instance.new("UICorner", SwitchBg)
        SwitchCorner.CornerRadius = UDim.new(1, 0)
        
        -- Knob
        local Knob = Instance.new("Frame", SwitchBg)
        Knob.Size = UDim2.new(0, 22, 0, 22)
        Knob.Position = UDim2.new(0, 1, 0.5, -11)
        Knob.BackgroundColor3 = Color3.fromRGB(120, 120, 120)
        Knob.BorderSizePixel = 0
        Knob.ZIndex = 14
        Knob.Active = false
        Knob.Selectable = false
        
        local KnobCorner = Instance.new("UICorner", Knob)
        KnobCorner.CornerRadius = UDim.new(1, 0)
        
        -- N√∫t b·∫•m th·ª±c t·∫ø
        local HitButton = Instance.new("TextButton", ToggleFrame)
        HitButton.Size = UDim2.new(1, 0, 1, 0)
        HitButton.BackgroundTransparency = 1
        HitButton.Text = ""
        HitButton.ZIndex = 15
        HitButton.Active = true
        HitButton.Selectable = true
        HitButton.Name = "ToggleHit_" .. text
        
        -- NgƒÉn kh√¥ng cho k√©o t·ª´ n√∫t toggle
        HitButton.InputBegan:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 
                or input.UserInputType == Enum.UserInputType.Touch then
                
                local connection
                connection = input.Changed:Connect(function()
                    if input.UserInputState == Enum.UserInputState.End then
                        if connection then
                            connection:Disconnect()
                        end
                    end
                end)
            end
        end)
        
        local state = default or false
        
        local function ApplyState(on)
            state = on
            if on then
                Knob.Position = UDim2.new(1, -23, 0.5, -11)
                Knob.BackgroundColor3 = Color3.fromRGB(60, 200, 90)
                SwitchBg.BackgroundColor3 = Color3.fromRGB(40, 140, 70)
            else
                Knob.Position = UDim2.new(0, 1, 0.5, -11)
                Knob.BackgroundColor3 = Color3.fromRGB(120, 120, 120)
                SwitchBg.BackgroundColor3 = Color3.fromRGB(55, 75, 55)
            end
        end
        
        ApplyState(state)
        
        HitButton.MouseButton1Click:Connect(function()
            ApplyState(not state)
            if callback then 
                pcall(function() 
                    callback(state) 
                end) 
            end
        end)
        
        return ToggleFrame
    end
    
    -- üìù LABEL
    function Window:CreateLabel(text)
        local Label = Instance.new("TextLabel", Container)
        Label.Size = UDim2.new(1, -20, 0, 28)
        Label.BackgroundTransparency = 1
        Label.Font = Enum.Font.GothamMedium
        Label.TextSize = 14
        Label.TextColor3 = Color3.fromRGB(200, 220, 200)
        Label.TextXAlignment = Enum.TextXAlignment.Left
        Label.Text = text
        Label.ZIndex = 12
        Label.Active = false
        Label.Selectable = false
        Label.Name = "Label_" .. text
        
        return Label
    end
    
    return Window
end

return UILibrary
