--// KHANHLY UI LIBRARY - FIXED VERSION
--// GitHub Ready | Correct Scroll | Live Controls | Wave Border

local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")

local Library = {}

--================ UTILS =================--
local function Round(obj, r)
    local c = Instance.new("UICorner")
    c.CornerRadius = UDim.new(0, r)
    c.Parent = obj
end

local function Tween(obj, info, props)
    TweenService:Create(obj, info, props):Play()
end

--================ WINDOW =================--
function Library:CreateWindow(cfg)
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "KhanhlyHub"
    ScreenGui.ResetOnSpawn = false
    ScreenGui.Parent = game.CoreGui

    -- MAIN FRAME (GIỐNG MẪU BẠN GỬI)
    local Main = Instance.new("Frame", ScreenGui)
    Main.Size = UDim2.new(0, 240, 0, 320)
    Main.Position = UDim2.new(0, 20, 0.5, -160)
    Main.BackgroundColor3 = Color3.fromRGB(25,25,25)
    Main.BackgroundTransparency = 0.15
    Main.Active = true
    Main.Draggable = true
    Round(Main, 8)

    -- STROKE + GRADIENT SÓNG
    local Stroke = Instance.new("UIStroke", Main)
    Stroke.Thickness = 2

    local Gradient = Instance.new("UIGradient", Stroke)
    Gradient.Color = ColorSequence.new{
        ColorSequenceKeypoint.new(0, Color3.fromRGB(80,180,255)),
        ColorSequenceKeypoint.new(1, Color3.fromRGB(160,90,255))
    }

    task.spawn(function()
        while true do
            TweenService:Create(
                Gradient,
                TweenInfo.new(4, Enum.EasingStyle.Linear),
                {Rotation = 360}
            ):Play()
            task.wait(4)
        end
    end)

    -- TITLE
    local Title = Instance.new("TextLabel", Main)
    Title.Size = UDim2.new(1,0,0,30)
    Title.Text = cfg.Title or "khanhly beta"
    Title.Font = Enum.Font.GothamBold
    Title.TextSize = 14
    Title.TextColor3 = Color3.fromRGB(230,230,230)
    Title.BackgroundColor3 = Color3.fromRGB(45,45,45)
    Round(Title, 8)

    -- SCROLL CONTAINER
    local Container = Instance.new("ScrollingFrame", Main)
    Container.Position = UDim2.new(0,5,0,35)
    Container.Size = UDim2.new(1,-10,1,-40)
    Container.CanvasSize = UDim2.new(0,0,0,0)
    Container.ScrollBarImageTransparency = 0.3
    Container.ScrollBarThickness = 6
    Container.BackgroundTransparency = 1
    Container.Active = true
    Container.AutomaticCanvasSize = Enum.AutomaticSize.None
    Container.ScrollingDirection = Enum.ScrollingDirection.Y

    local Layout = Instance.new("UIListLayout", Container)
    Layout.Padding = UDim.new(0,8)
    Layout.HorizontalAlignment = Enum.HorizontalAlignment.Center

    Layout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
        Container.CanvasSize = UDim2.new(0,0,0,Layout.AbsoluteContentSize.Y + 10)
    end)

    -- OPEN BUTTON
    local OpenBtn = Instance.new("ImageButton", ScreenGui)
    OpenBtn.Size = UDim2.new(0,44,0,44)
    OpenBtn.Position = UDim2.new(0,20,0.5,-22)
    OpenBtn.BackgroundColor3 = Color3.fromRGB(35,35,35)
    OpenBtn.AutoButtonColor = false
    OpenBtn.Active = true
    OpenBtn.Draggable = true
    Round(OpenBtn, 22)

    local OBStroke = Instance.new("UIStroke", OpenBtn)
    OBStroke.Thickness = 2
    OBStroke.Color = Color3.fromRGB(120,180,255)

    OpenBtn.MouseButton1Click:Connect(function()
        Main.Visible = not Main.Visible
    end)

    local Window = {}

    -- EDIT OPEN BUTTON
    function Window:EditOpenButton(cfg2)
        if cfg2.Icon then OpenBtn.Image = cfg2.Icon end
        if cfg2.Size then OpenBtn.Size = cfg2.Size end
        if cfg2.Position then OpenBtn.Position = cfg2.Position end
        if cfg2.BackgroundColor then OpenBtn.BackgroundColor3 = cfg2.BackgroundColor end
        if cfg2.StrokeColor then OBStroke.Color = cfg2.StrokeColor end
    end

    -- TAB (THỰC CHẤT DÙNG CHUNG CONTAINER ĐỂ GIỐNG UI MẪU)
    function Window:CreateTab()
        local Tab = {}

        function Tab:CreateButton(text, callback)
            local btn = Instance.new("TextButton", Container)
            btn.Size = UDim2.new(1,0,0,35)
            btn.Text = text
            btn.Font = Enum.Font.Gotham
            btn.TextSize = 13
            btn.TextColor3 = Color3.new(1,1,1)
            btn.BackgroundColor3 = Color3.fromRGB(45,45,45)
            Round(btn,6)

            btn.MouseEnter:Connect(function()
                Tween(btn, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(60,60,60)})
            end)
            btn.MouseLeave:Connect(function()
                Tween(btn, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(45,45,45)})
            end)

            btn.MouseButton1Click:Connect(callback)
        end

        function Tab:CreateToggle(text, default, callback)
            local holder = Instance.new("Frame", Container)
            holder.Size = UDim2.new(1,0,0,34)
            holder.BackgroundTransparency = 1

            local label = Instance.new("TextLabel", holder)
            label.Size = UDim2.new(0.7,0,1,0)
            label.Text = text
            label.Font = Enum.Font.Gotham
            label.TextSize = 13
            label.TextColor3 = Color3.fromRGB(230,230,230)
            label.BackgroundTransparency = 1
            label.TextXAlignment = Left

            local toggle = Instance.new("Frame", holder)
            toggle.Size = UDim2.new(0,46,0,20)
            toggle.Position = UDim2.new(1,-50,0.5,-10)
            toggle.BackgroundColor3 = Color3.fromRGB(70,70,70)
            Round(toggle,10)

            local circle = Instance.new("Frame", toggle)
            circle.Size = UDim2.new(0,16,0,16)
            circle.Position = UDim2.new(0,2,0.5,-8)
            circle.BackgroundColor3 = Color3.fromRGB(220,220,220)
            Round(circle,8)

            local state = default

            local function refresh()
                if state then
                    Tween(toggle, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(90,180,255)})
                    Tween(circle, TweenInfo.new(0.2), {Position = UDim2.new(1,-18,0.5,-8)})
                else
                    Tween(toggle, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(70,70,70)})
                    Tween(circle, TweenInfo.new(0.2), {Position = UDim2.new(0,2,0.5,-8)})
                end
            end

            toggle.InputBegan:Connect(function(i)
                if i.UserInputType == Enum.UserInputType.MouseButton1 then
                    state = not state
                    refresh()
                    callback(state)
                end
            end)

            refresh()
        end

        function Tab:CreateSlider(text, min, max, default, callback)
            local holder = Instance.new("Frame", Container)
            holder.Size = UDim2.new(1,0,0,50)
            holder.BackgroundTransparency = 1

            local label = Instance.new("TextLabel", holder)
            label.Size = UDim2.new(1,0,0,20)
            label.Text = text .. ": " .. default
            label.Font = Enum.Font.Gotham
            label.TextSize = 13
            label.TextColor3 = Color3.fromRGB(200,220,255)
            label.BackgroundTransparency = 1
            label.TextXAlignment = Left

            local bar = Instance.new("Frame", holder)
            bar.Position = UDim2.new(0,0,0,28)
            bar.Size = UDim2.new(1,0,0,8)
            bar.BackgroundColor3 = Color3.fromRGB(60,60,60)
            Round(bar,8)

            local fill = Instance.new("Frame", bar)
            fill.Size = UDim2.new((default-min)/(max-min),0,1,0)
            fill.BackgroundColor3 = Color3.fromRGB(120,180,255)
            Round(fill,8)

            local dragging = false

            bar.InputBegan:Connect(function(i)
                if i.UserInputType == Enum.UserInputType.MouseButton1 then dragging = true end
            end)
            UserInputService.InputEnded:Connect(function(i)
                if i.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end
            end)
            UserInputService.InputChanged:Connect(function(i)
                if dragging and i.UserInputType == Enum.UserInputType.MouseMovement then
                    local p = math.clamp((i.Position.X-bar.AbsolutePosition.X)/bar.AbsoluteSize.X,0,1)
                    fill.Size = UDim2.new(p,0,1,0)
                    local val = math.floor(min+(max-min)*p)
                    label.Text = text .. ": " .. val
                    callback(val)
                end
            end)
        end

        return Tab
    end

    return Window
end

return Library
