--// KHANHLY UI LIBRARY - RUBY RED TOGGLE
--// GitHub Ready | Correct Scroll | Live Controls | Wave Border | Ruby Theme

local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")

local Library = {}

--================ UTILS =================--
local function GetInputPosition(input)
    if not input then return nil end
    if input.Position then return input.Position end
    if UserInputService:GetLastInputType() == Enum.UserInputType.Touch then
        local touches = UserInputService:GetTouches()
        if touches and touches[1] then
            return touches[1].Position
        end
    end
    return nil
end

local function IsInputInFrame(frame, input)
    local posInput = GetInputPosition(input)
    if not posInput then return false end
    local pos = frame.AbsolutePosition
    local size = frame.AbsoluteSize
    return posInput.X >= pos.X and posInput.X <= pos.X + size.X and
           posInput.Y >= pos.Y and posInput.Y <= pos.Y + size.Y
end

local function Round(obj, r)
    local c = Instance.new("UICorner")
    c.CornerRadius = UDim.new(0, r)
    c.Parent = obj
end

local function Tween(obj, info, props)
    local tween = TweenService:Create(obj, info, props)
    tween:Play()
    return tween
end

--================ THEME =================--
local Theme = {
    Ruby = Color3.fromRGB(255, 70, 120),     -- đỏ hồng ngọc
    RubyRed = Color3.fromRGB(220, 40, 90),   -- đỏ hồng ngọc đậm hơn
    Purple = Color3.fromRGB(170, 90, 255),   -- tím
    Ocean = Color3.fromRGB(0, 160, 220),     -- xanh biển
    Dark = Color3.fromRGB(25, 25, 25),       -- nền tối
    DarkGray = Color3.fromRGB(45, 45, 45),   -- xám đậm
    MediumGray = Color3.fromRGB(60, 60, 60), -- xám trung
    LightGray = Color3.fromRGB(230, 230, 230), -- xám sáng
    White = Color3.fromRGB(240, 240, 240)    -- trắng
}

-- GRADIENT SÓNG DÙNG CHUNG
local WaveGradient = ColorSequence.new{
    ColorSequenceKeypoint.new(0, Theme.Ruby),     -- đỏ hồng ngọc
    ColorSequenceKeypoint.new(0.5, Theme.Purple), -- tím
    ColorSequenceKeypoint.new(1, Theme.Ocean)     -- xanh biển
}

--================ WINDOW =================--
function Library:CreateWindow(cfg)
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "KhanhlyHub"
    ScreenGui.ResetOnSpawn = false
    ScreenGui.Parent = game.CoreGui

    -- Lưu vị trí và kích thước gốc
    local savedPosition = UDim2.new(0, 20, 0.5, -160)
    local savedSize = UDim2.new(0, 240, 0, 320)
    
    -- MAIN FRAME
    local Main = Instance.new("Frame", ScreenGui)
    Main.Size = savedSize
    Main.Position = savedPosition
    Main.BackgroundColor3 = Theme.Dark
    Main.BackgroundTransparency = 0.15
    Main.Active = true
    Main.Draggable = true
    Main.Visible = false
    Round(Main, 8)

    -- VIỀN SÓNG WAVE GRADIENT
    local Stroke = Instance.new("UIStroke", Main)
    Stroke.Thickness = 2
    Stroke.Color = Theme.Ruby

    local StrokeGradient = Instance.new("UIGradient", Stroke)
    StrokeGradient.Color = WaveGradient
    StrokeGradient.Rotation = 0
    StrokeGradient.Enabled = true

    -- Animation xoay viền sóng
    task.spawn(function()
        while true do
            StrokeGradient.Rotation = StrokeGradient.Rotation + 1
            task.wait(0.03)
        end
    end)

    -- TITLE - MÀU RUBY
    local Title = Instance.new("TextLabel", Main)
    Title.Size = UDim2.new(1,0,0,30)
    Title.Text = cfg.Title or "khanhly beta"
    Title.Font = Enum.Font.GothamBold
    Title.TextSize = 14
    Title.TextColor3 = Theme.Ruby
    Title.BackgroundColor3 = Theme.DarkGray
    Title.TextXAlignment = Enum.TextXAlignment.Center
    Round(Title, 8)

    -- SCROLL CONTAINER
    local Container = Instance.new("ScrollingFrame", Main)
    Container.Position = UDim2.new(0,5,0,35)
    Container.Size = UDim2.new(1,-10,1,-40)
    Container.CanvasSize = UDim2.new(0,0,0,0)
    Container.ScrollBarImageTransparency = 0.3
    Container.ScrollBarThickness = 6
    Container.BackgroundTransparency = 1
    Container.Active = true
    Container.AutomaticCanvasSize = Enum.AutomaticSize.Y
    Container.ScrollingDirection = Enum.ScrollingDirection.Y
    Container.ScrollBarImageColor3 = Theme.Purple
    Container.VerticalScrollBarInset = Enum.ScrollBarInset.Always
    Container.ElasticBehavior = Enum.ElasticBehavior.Always

    local Layout = Instance.new("UIListLayout", Container)
    Layout.Padding = UDim.new(0,8)
    Layout.HorizontalAlignment = Enum.HorizontalAlignment.Center

    -- OPEN BUTTON VỚI VIỀN SÓNG
    local OpenBtn = Instance.new("ImageButton", ScreenGui)
    OpenBtn.Size = UDim2.new(0,44,0,44)
    OpenBtn.Position = UDim2.new(0,20,0.5,-22)
    OpenBtn.BackgroundColor3 = Theme.DarkGray
    OpenBtn.AutoButtonColor = false
    OpenBtn.Active = true
    OpenBtn.Draggable = true
    Round(OpenBtn, 22)

    local OBStroke = Instance.new("UIStroke", OpenBtn)
    OBStroke.Thickness = 2
    OBStroke.Color = Theme.Ruby

    local OBGradient = Instance.new("UIGradient", OBStroke)
    OBGradient.Color = WaveGradient
    OBGradient.Rotation = 0

    -- Animation xoay viền cho nút mở
    task.spawn(function()
        while true do
            OBGradient.Rotation = OBGradient.Rotation + 1
            task.wait(0.03)
        end
    end)

    -- Hiệu ứng ẩn/hiện UI
    local uiVisible = false
    local isAnimating = false
    
    local function toggleUI()
        if isAnimating then return end
        isAnimating = true
        
        if uiVisible then
            -- Lưu vị trí hiện tại trước khi ẩn
            savedPosition = Main.Position
            savedSize = Main.Size
            
            -- Ẩn UI với hiệu ứng thu nhỏ
            local hideTween = TweenService:Create(Main, TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
                Size = UDim2.new(0, 0, 0, 0),
                Position = UDim2.new(
                    savedPosition.X.Scale, 
                    savedPosition.X.Offset + savedSize.X.Offset/2,
                    savedPosition.Y.Scale,
                    savedPosition.Y.Offset + savedSize.Y.Offset/2
                ),
                BackgroundTransparency = 1
            })
            
            hideTween.Completed:Connect(function()
                Main.Visible = false
                isAnimating = false
            end)
            
            hideTween:Play()
        else
            -- Hiện UI với hiệu ứng phóng to từ tâm
            Main.Visible = true
            Main.Size = UDim2.new(0, 0, 0, 0)
            Main.Position = UDim2.new(
                savedPosition.X.Scale, 
                savedPosition.X.Offset + savedSize.X.Offset/2,
                savedPosition.Y.Scale,
                savedPosition.Y.Offset + savedSize.Y.Offset/2
            )
            Main.BackgroundTransparency = 1
            
            local showTween = TweenService:Create(Main, TweenInfo.new(0.3, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {
                Size = savedSize,
                Position = savedPosition,
                BackgroundTransparency = 0.15
            })
            
            showTween.Completed:Connect(function()
                isAnimating = false
            end)
            
            showTween:Play()
        end
        uiVisible = not uiVisible
    end

    -- Xử lý cả PC và Mobile cho Open Button
    OpenBtn.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            toggleUI()
        end
    end)

    local Window = {}

    -- EDIT OPEN BUTTON
    function Window:EditOpenButton(cfg2)
        if cfg2.Icon then OpenBtn.Image = cfg2.Icon end
        if cfg2.Size then OpenBtn.Size = cfg2.Size end
        if cfg2.Position then 
            OpenBtn.Position = cfg2.Position 
        end
        if cfg2.BackgroundColor then OpenBtn.BackgroundColor3 = cfg2.BackgroundColor end
        if cfg2.StrokeColor then OBStroke.Color = cfg2.StrokeColor end
    end

    -- TAB
    function Window:CreateTab()
        local Tab = {}

        function Tab:CreateButton(text, callback)
            local btn = Instance.new("TextButton", Container)
            btn.Size = UDim2.new(0.95, 0, 0, 35)
            btn.Text = text
            btn.Font = Enum.Font.Gotham
            btn.TextSize = 13
            btn.TextColor3 = Theme.White
            btn.BackgroundColor3 = Theme.DarkGray
            btn.AutoButtonColor = false
            btn.Active = true
            Round(btn,6)
            
            -- Stroke cho button với màu theme
            local btnStroke = Instance.new("UIStroke", btn)
            btnStroke.Thickness = 1
            btnStroke.Color = Theme.Purple
            
            local btnHighlight = Instance.new("UIStroke", btn)
            btnHighlight.Thickness = 1
            btnHighlight.Color = Theme.Ruby
            btnHighlight.Transparency = 0.8
            btnHighlight.LineJoinMode = Enum.LineJoinMode.Round

            -- Hiệu ứng hover (chỉ PC)
            btn.MouseEnter:Connect(function()
                if uiVisible then
                    Tween(btn, TweenInfo.new(0.2), {BackgroundColor3 = Theme.MediumGray})
                    Tween(btnStroke, TweenInfo.new(0.2), {Color = Theme.Ocean})
                    Tween(btnHighlight, TweenInfo.new(0.2), {Transparency = 0.3})
                end
            end)
            
            btn.MouseLeave:Connect(function()
                if uiVisible then
                    Tween(btn, TweenInfo.new(0.2), {BackgroundColor3 = Theme.DarkGray})
                    Tween(btnStroke, TweenInfo.new(0.2), {Color = Theme.Purple})
                    Tween(btnHighlight, TweenInfo.new(0.2), {Transparency = 0.8})
                end
            end)

            -- Xử lý click/touch CHUẨN
            local isClicking = false
            
            btn.InputBegan:Connect(function(input)
                if not uiVisible then return end
                
                if input.UserInputType == Enum.UserInputType.MouseButton1 or 
                   input.UserInputType == Enum.UserInputType.Touch then
                    
                    if IsInputInFrame(btn, input) then
                        isClicking = true
                        Tween(btn, TweenInfo.new(0.1), {BackgroundColor3 = Theme.Ruby})
                        Tween(btnStroke, TweenInfo.new(0.1), {Color = Theme.Ruby})
                    end
                end
            end)
            
            btn.InputEnded:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseButton1 or 
                   input.UserInputType == Enum.UserInputType.Touch then
                    
                    if isClicking then
                        if IsInputInFrame(btn, input) then
                            Tween(btn, TweenInfo.new(0.1), {BackgroundColor3 = Theme.Ocean})
                            Tween(btnStroke, TweenInfo.new(0.1), {Color = Theme.Ocean})
                            task.wait(0.05)
                            Tween(btn, TweenInfo.new(0.1), {BackgroundColor3 = Theme.DarkGray})
                            Tween(btnStroke, TweenInfo.new(0.1), {Color = Theme.Purple})
                            callback()
                        else
                            Tween(btn, TweenInfo.new(0.1), {BackgroundColor3 = Theme.DarkGray})
                            Tween(btnStroke, TweenInfo.new(0.1), {Color = Theme.Purple})
                        end
                        isClicking = false
                    end
                end
            end)
        end

        function Tab:CreateToggle(text, default, callback)
            local holder = Instance.new("Frame", Container)
            holder.Size = UDim2.new(0.95, 0, 0, 34)
            holder.BackgroundTransparency = 1

            local label = Instance.new("TextLabel", holder)
            label.Size = UDim2.new(0.7,0,1,0)
            label.Position = UDim2.new(0, 0, 0, 0)
            label.Text = text
            label.Font = Enum.Font.Gotham
            label.TextSize = 13
            label.TextColor3 = Theme.LightGray
            label.BackgroundTransparency = 1
            label.TextXAlignment = Enum.TextXAlignment.Left

            local toggleContainer = Instance.new("TextButton", holder)
            toggleContainer.Size = UDim2.new(0,46,0,20)
            toggleContainer.Position = UDim2.new(1,-50,0.5,-10)
            toggleContainer.BackgroundColor3 = Theme.DarkGray
            toggleContainer.BorderSizePixel = 0
            toggleContainer.AutoButtonColor = false
            toggleContainer.Text = ""
            toggleContainer.Active = true
            Round(toggleContainer,10)
            
            -- Viền cho toggle
            local toggleStroke = Instance.new("UIStroke", toggleContainer)
            toggleStroke.Thickness = 1
            toggleStroke.Color = Theme.Ruby

            local circle = Instance.new("Frame", toggleContainer)
            circle.Size = UDim2.new(0,16,0,16)
            circle.Position = UDim2.new(0,2,0.5,-8)
            circle.BackgroundColor3 = Theme.White
            circle.BorderSizePixel = 0
            Round(circle,8)
            
            local circleStroke = Instance.new("UIStroke", circle)
            circleStroke.Thickness = 1
            circleStroke.Color = Theme.Ruby

            local state = default or false

            local function refresh()
                if state then
                    -- ON: ĐỎ HỒNG NGỌC
                    Tween(toggleContainer, TweenInfo.new(0.2), {BackgroundColor3 = Theme.RubyRed})
                    Tween(toggleStroke, TweenInfo.new(0.2), {Color = Theme.RubyRed})
                    Tween(circle, TweenInfo.new(0.2), {Position = UDim2.new(1,-18,0.5,-8)})
                    Tween(circle, TweenInfo.new(0.2), {BackgroundColor3 = Theme.White})
                    Tween(circleStroke, TweenInfo.new(0.2), {Color = Theme.White})
                else
                    -- OFF: XÁM
                    Tween(toggleContainer, TweenInfo.new(0.2), {BackgroundColor3 = Theme.DarkGray})
                    Tween(toggleStroke, TweenInfo.new(0.2), {Color = Theme.Ruby})
                    Tween(circle, TweenInfo.new(0.2), {Position = UDim2.new(0,2,0.5,-8)})
                    Tween(circle, TweenInfo.new(0.2), {BackgroundColor3 = Theme.White})
                    Tween(circleStroke, TweenInfo.new(0.2), {Color = Theme.Ruby})
                end
            end

            -- Xử lý click/touch CHUẨN cho Toggle
            toggleContainer.InputBegan:Connect(function(input)
                if not uiVisible then return end
                
                if input.UserInputType == Enum.UserInputType.MouseButton1 or 
                   input.UserInputType == Enum.UserInputType.Touch then
                    
                    if IsInputInFrame(toggleContainer, input) then
                        state = not state
                        refresh()
                        callback(state)
                    end
                end
            end)

            refresh()
        end

        function Tab:CreateSlider(text, min, max, default, callback)
            local holder = Instance.new("Frame", Container)
            holder.Size = UDim2.new(0.95, 0, 0, 60)
            holder.BackgroundTransparency = 1

            local label = Instance.new("TextLabel", holder)
            label.Size = UDim2.new(1,0,0,20)
            label.Text = text .. ": " .. default
            label.Font = Enum.Font.Gotham
            label.TextSize = 13
            label.TextColor3 = Theme.Ocean
            label.BackgroundTransparency = 1
            label.TextXAlignment = Enum.TextXAlignment.Left

            local bar = Instance.new("TextButton", holder)
            bar.Position = UDim2.new(0,0,0,28)
            bar.Size = UDim2.new(1,0,0,12)
            bar.BackgroundColor3 = Theme.DarkGray
            bar.BorderSizePixel = 0
            bar.AutoButtonColor = false
            bar.Text = ""
            bar.Active = true
            Round(bar,6)
            
            local barStroke = Instance.new("UIStroke", bar)
            barStroke.Thickness = 1
            barStroke.Color = Theme.Purple

            local fill = Instance.new("Frame", bar)
            fill.Size = UDim2.new((default-min)/(max-min),0,1,0)
            fill.BackgroundColor3 = Theme.Ocean
            fill.BorderSizePixel = 0
            Round(fill,6)
            
            -- TẠO GRADIENT SÓNG CHO SLIDER FILL
            local fillGradient = Instance.new("UIGradient", fill)
            fillGradient.Color = WaveGradient
            fillGradient.Rotation = 0
            fillGradient.Enabled = true
            
            local fillStroke = Instance.new("UIStroke", fill)
            fillStroke.Thickness = 1
            fillStroke.Color = Theme.Ruby

            -- Animation xoay gradient cho slider fill
            task.spawn(function()
                while fill and fill.Parent do
                    fillGradient.Rotation = fillGradient.Rotation + 1
                    task.wait(0.03)
                end
            end)

            -- Biến cho slider (CHUẨN CHO CẢ PC VÀ MOBILE)
            local dragging = false
            local currentValue = default
            local activeInput -- input đang drag (touch hoặc mouse)

            local function updateSliderFromInput(input)
                if not uiVisible then return end
                if not dragging then return end
                
                local pos = GetInputPosition(input)
                if not pos then return end
                
                local absPos = bar.AbsolutePosition
                local absSize = bar.AbsoluteSize
                local inputX = pos.X
                
                local relativeX = (inputX - absPos.X) / absSize.X
                relativeX = math.clamp(relativeX, 0, 1)
                
                fill.Size = UDim2.new(relativeX, 0, 1, 0)
                currentValue = math.floor(min + (max - min) * relativeX)
                label.Text = text .. ": " .. currentValue
                callback(currentValue)
            end

            -- Xử lý input CHUẨN cho Slider
            bar.InputBegan:Connect(function(input)
                if not uiVisible then return end
                
                if input.UserInputType == Enum.UserInputType.MouseButton1 or 
                   input.UserInputType == Enum.UserInputType.Touch then
                    
                    if IsInputInFrame(bar, input) then
                        dragging = true
                        activeInput = input
                        Tween(fill, TweenInfo.new(0.1), {BackgroundColor3 = Theme.Ruby})
                        Tween(fillStroke, TweenInfo.new(0.1), {Color = Theme.Ruby})
                        updateSliderFromInput(input)
                    end
                end
            end)
            
            bar.InputEnded:Connect(function(input)
                if input == activeInput then
                    dragging = false
                    activeInput = nil
                    Tween(fill, TweenInfo.new(0.1), {BackgroundColor3 = Theme.Ocean})
                    Tween(fillStroke, TweenInfo.new(0.1), {Color = Theme.Ruby})
                end
            end)
            
            UserInputService.InputChanged:Connect(function(input)
                if dragging and input == activeInput then
                    updateSliderFromInput(input)
                end
            end)
            
            -- Hiệu ứng hover chỉ cho PC
            bar.MouseEnter:Connect(function()
                if uiVisible then
                    Tween(barStroke, TweenInfo.new(0.2), {Color = Theme.Ocean})
                end
            end)
            
            bar.MouseLeave:Connect(function()
                if uiVisible and not dragging then
                    Tween(barStroke, TweenInfo.new(0.2), {Color = Theme.Purple})
                end
            end)
        end

        return Tab
    end

    return Window
end

return Library
